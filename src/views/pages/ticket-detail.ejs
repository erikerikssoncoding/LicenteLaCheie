<%- include('../partials/head', { title, description, request }) %>
<%- include('../partials/header') %>
<section class="py-5 py-lg-6">
  <div class="container" style="max-width: 820px;">
    <div class="glass-card mb-4">
      <h1 class="h4 mb-3"><%= ticket.subject %></h1>
      <p class="text-muted">Status: <span class="badge text-bg-info text-dark text-uppercase"><%= ticket.status %></span></p>
      <% if (ticket.project_title) { %>
      <p class="mb-0">Proiect: <strong><%= ticket.project_title %></strong></p>
      <% } %>
    </div>

    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-content">
          <h2 class="h6">Mesaj initial</h2>
          <p><%= ticket.message %></p>
          <small class="text-muted">Creat de <%= ticket.author_name %></small>
        </div>
      </div>
      <% replies.forEach((reply) => { %>
      <div class="timeline-item">
        <div class="timeline-content">
          <h2 class="h6">Raspuns</h2>
          <p><%= reply.message %></p>
          <small class="text-muted">Trimis de <%= reply.author_name %></small>
        </div>
      </div>
      <% }) %>
    </div>

    <div class="glass-card mt-4">
      <form action="/cont/tichete/<%= ticket.id %>/raspuns" method="post" class="vstack gap-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div>
          <label class="form-label" for="message">Adauga raspuns</label>
          <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
        </div>
        <button class="btn btn-gradient align-self-end" type="submit">Trimite raspuns</button>
      </form>
    </div>

    <% if (['admin', 'superadmin'].includes(currentUser.role)) { %>
    <div class="glass-card mt-4">
      <form action="/cont/tichete/<%= ticket.id %>/status" method="post" class="d-flex flex-column flex-sm-row gap-3 align-items-sm-end">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="flex-grow-1 w-100">
          <label class="form-label" for="status">Actualizeaza statusul</label>
          <select class="form-select" id="status" name="status">
            <option value="deschis">Deschis</option>
            <option value="in-analiza">In analiza</option>
            <option value="rezolvat">Rezolvat</option>
          </select>
        </div>
        <button class="btn btn-outline-primary" type="submit">Salveaza</button>
      </form>
    </div>
    <% } %>
  </div>
</section>
<%- include('../partials/footer') %>
