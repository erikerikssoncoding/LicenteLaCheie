<%- include('../partials/head', { title, description, request }) %>
<%- include('../partials/header') %>
<section class="py-5">
  <div class="container" style="max-width: 960px;">
    <% const isClient = currentUser.role === 'client'; %>
    <% const isManager = ['admin', 'superadmin'].includes(currentUser.role); %>
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
      <div>
        <h1 class="h3 mb-1">Cont</h1>
        <p class="text-muted mb-0">
          <%= isClient
            ? 'Centralizeaza datele personale, ticketele si contractele semnate intr-un singur loc.'
            : 'Administreaza informatiile contului si resursele proiectelor pe care le coordonezi pentru clienti.'
          %>
        </p>
      </div>
      <div class="text-md-end">
        <span class="badge bg-light text-dark border">Rol: <span class="text-uppercase"><%= currentUser.role %></span></span>
      </div>
    </div>

    <% const currentTab = ['profile', 'tickets', 'contracts', 'projects', 'security'].includes(activeTab)
      ? activeTab
      : 'profile'; %>
    <% const alerts = feedback || {}; %>
    <% const ticketStatusLabels = { deschis: 'Deschis', 'in-analiza': 'In analiza', rezolvat: 'Rezolvat' }; %>
    <% const projectStatusLabels = Object.fromEntries(
      (projectStatuses || []).map((status) => [status.id, status.label])
    ); %>

    <ul class="nav nav-pills flex-wrap gap-2 mb-4" id="accountTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link <%= currentTab === 'profile' ? 'active' : '' %>"
          id="tab-profile-tab"
          data-bs-toggle="tab"
          data-bs-target="#tab-profile"
          type="button"
          role="tab"
          aria-controls="tab-profile"
          aria-selected="<%= currentTab === 'profile' ? 'true' : 'false' %>"
        >
          Date cont
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link <%= currentTab === 'tickets' ? 'active' : '' %>"
          id="tab-tickets-tab"
          data-bs-toggle="tab"
          data-bs-target="#tab-tickets"
          type="button"
          role="tab"
          aria-controls="tab-tickets"
          aria-selected="<%= currentTab === 'tickets' ? 'true' : 'false' %>"
        >
          Tickete
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link <%= currentTab === 'contracts' ? 'active' : '' %>"
          id="tab-contracts-tab"
          data-bs-toggle="tab"
          data-bs-target="#tab-contracts"
          type="button"
          role="tab"
          aria-controls="tab-contracts"
          aria-selected="<%= currentTab === 'contracts' ? 'true' : 'false' %>"
        >
          Contracte
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link <%= currentTab === 'projects' ? 'active' : '' %>"
          id="tab-projects-tab"
          data-bs-toggle="tab"
          data-bs-target="#tab-projects"
          type="button"
          role="tab"
          aria-controls="tab-projects"
          aria-selected="<%= currentTab === 'projects' ? 'true' : 'false' %>"
        >
          <%= isClient ? 'Proiectele mele' : 'Proiecte gestionate' %>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link <%= currentTab === 'security' ? 'active' : '' %>"
          id="tab-security-tab"
          data-bs-toggle="tab"
          data-bs-target="#tab-security"
          type="button"
          role="tab"
          aria-controls="tab-security"
          aria-selected="<%= currentTab === 'security' ? 'true' : 'false' %>"
        >
          Parole si securitate
        </button>
      </li>
    </ul>

    <div class="tab-content" id="accountTabContent">
      <div
        class="tab-pane fade <%= currentTab === 'profile' ? 'show active' : '' %>"
        id="tab-profile"
        role="tabpanel"
        aria-labelledby="tab-profile-tab"
        tabindex="0"
      >
        <% if (alerts.profileSuccess) { %>
        <div class="alert alert-success mb-4"><%= alerts.profileSuccess %></div>
        <% } %>
        <% if (alerts.profileError) { %>
        <div class="alert alert-danger mb-4"><%= alerts.profileError %></div>
        <% } %>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3 mb-4">
              <div>
                <h2 class="h5 mb-1">Date personale</h2>
                <p class="text-muted mb-0">
                  <%= isClient
                    ? 'Actualizeaza informatiile de contact folosite in comunicarea cu echipa.'
                    : 'Actualizeaza datele vizibile clientilor si colegilor in proiectele active.'
                  %>
                </p>
              </div>
              <span class="badge bg-light text-dark">Ultima actualizare: <%= profile.updated_at?.toISOString ? profile.updated_at.toISOString().slice(0, 10) : '—' %></span>
            </div>
            <form action="/cont/setari" method="post" class="vstack gap-3">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <div>
                <label class="form-label" for="email">Adresa email</label>
                <input
                  class="form-control"
                  type="email"
                  id="email"
                  name="email"
                  value="<%= profile.email %>"
                  disabled
                />
                <small class="text-muted">Pentru actualizarea adresei de email contacteaza administratorul platformei.</small>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="fullName">Nume complet</label>
                  <input
                    class="form-control"
                    type="text"
                    id="fullName"
                    name="fullName"
                    value="<%= profile.full_name %>"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="phone">Telefon</label>
                  <input
                    class="form-control"
                    type="tel"
                    id="phone"
                    name="phone"
                    value="<%= profile.phone || '' %>"
                  />
                </div>
              </div>
              <div class="text-end">
                <button class="btn btn-primary" type="submit">Salveaza modificarile</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div
        class="tab-pane fade <%= currentTab === 'tickets' ? 'show active' : '' %>"
        id="tab-tickets"
        role="tabpanel"
        aria-labelledby="tab-tickets-tab"
        tabindex="0"
      >
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
              <div>
                <h2 class="h5 mb-1"><%= isClient ? 'Ticketele mele' : 'Tickete asignate' %></h2>
                <p class="text-muted mb-0">
                  <%= isClient
                    ? 'Urmariti solicitarile trimise si raspunsurile echipei.'
                    : 'Monitorizeaza solicitarile primite de la clienti si statusul interventiilor.'
                  %>
                </p>
              </div>
              <% if (isClient) { %>
              <a class="btn btn-outline-primary btn-sm" href="/cont/tichete/creeaza">Deschide ticket</a>
              <% } else { %>
              <a class="btn btn-outline-primary btn-sm" href="/cont/tichete">Vezi toate tichetele</a>
              <% } %>
            </div>
            <% if (!tickets || tickets.length === 0) { %>
            <p class="text-muted mb-0">
              <%= isClient
                ? 'Momentan nu exista tickete asociate contului tau.'
                : 'Nu ai tichete asignate momentan.'
              %>
            </p>
            <% } else { %>
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th scope="col">Cod</th>
                    <th scope="col">Subiect</th>
                    <th scope="col">Status</th>
                    <th scope="col">Actualizat</th>
                    <th scope="col" class="text-end">Actiuni</th>
                  </tr>
                </thead>
                <tbody>
                  <% tickets.forEach((ticket) => { %>
                  <tr>
                    <td>
                      <span class="badge bg-light text-dark">#<%= ticket.display_code %></span>
                    </td>
                    <td>
                      <div class="fw-semibold"><%= ticket.subject %></div>
                      <% if (ticket.project_title) { %>
                      <div class="small text-muted">Proiect: <%= ticket.project_title %></div>
                      <% } %>
                      <div class="small text-muted text-uppercase">Tip: <%= ticket.kind %></div>
                    </td>
                    <td>
                      <span class="badge bg-secondary"><%= ticketStatusLabels[ticket.status] || ticket.status %></span>
                    </td>
                    <td class="text-muted">
                      <%= ticket.updated_at?.toISOString
                        ? ticket.updated_at.toISOString().slice(0, 10)
                        : ticket.updated_at?.toString() || '—' %>
                    </td>
                    <td class="text-end">
                      <a class="btn btn-sm btn-outline-primary" href="/cont/tichete/<%= ticket.id %>">Vezi ticket</a>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <div
        class="tab-pane fade <%= currentTab === 'contracts' ? 'show active' : '' %>"
        id="tab-contracts"
        role="tabpanel"
        aria-labelledby="tab-contracts-tab"
        tabindex="0"
      >
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="mb-4">
              <h2 class="h5 mb-1">Contracte semnate</h2>
              <p class="text-muted mb-0">
                <%= isClient
                  ? 'Acceseaza rapid contractele finalizate si semnate de ambele parti.'
                  : 'Consulta contractele finalizate pentru clientii din portofoliul tau.'
                %>
              </p>
            </div>
            <% if (!contracts || contracts.length === 0) { %>
            <p class="text-muted mb-0">
              <%= isClient
                ? 'Nu exista contracte semnate disponibile pentru descarcare in acest moment.'
                : 'Nu exista contracte finalizate pentru portofoliul tau.'
              %>
            </p>
            <% } else { %>
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th scope="col">Numar</th>
                    <th scope="col">Ticket</th>
                    <th scope="col">Proiect</th>
                    <th scope="col">Data semnarii</th>
                    <th scope="col" class="text-end">Actiuni</th>
                  </tr>
                </thead>
                <tbody>
                  <% contracts.forEach((contract) => { %>
                  <tr>
                    <td>
                      <strong><%= contract.contract_number || '—' %></strong>
                    </td>
                    <td>
                      <div class="fw-semibold">#<%= contract.ticket_code %></div>
                      <div class="small text-muted"><%= contract.ticket_subject %></div>
                    </td>
                    <td>
                      <% if (contract.project_title) { %>
                      <div class="fw-semibold"><%= contract.project_title %></div>
                      <% } else { %>
                      <span class="text-muted">—</span>
                      <% } %>
                      <% if (contract.client_name && isManager) { %>
                      <div class="small text-muted">Client: <%= contract.client_name %></div>
                      <% } %>
                    </td>
                    <td class="text-muted">
                      <%= contract.contract_date?.toISOString
                        ? contract.contract_date.toISOString().slice(0, 10)
                        : contract.contract_date?.toString() || '—' %>
                    </td>
                    <td class="text-end">
                      <div class="d-flex flex-column flex-lg-row gap-2 justify-content-end">
                        <a class="btn btn-sm btn-outline-secondary" href="/cont/tichete/<%= contract.ticket_id %>">
                          Deschide ticket
                        </a>
                        <form action="/cont/tichete/<%= contract.ticket_id %>/contract/descarca" method="post" class="d-inline">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                          <button class="btn btn-sm btn-outline-primary" type="submit">Descarca PDF</button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <div
        class="tab-pane fade <%= currentTab === 'projects' ? 'show active' : '' %>"
        id="tab-projects"
        role="tabpanel"
        aria-labelledby="tab-projects-tab"
        tabindex="0"
      >
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="mb-4">
              <h2 class="h5 mb-1"><%= isClient ? 'Proiectele mele' : 'Proiecte gestionate' %></h2>
              <p class="text-muted mb-0">
                <%= isClient
                  ? 'Monitorizeaza statusul proiectelor si termenele stabilite.'
                  : 'Verifica proiectele asignate si prioritatile agreate cu clientii.'
                %>
              </p>
            </div>
            <% if (!projects || projects.length === 0) { %>
            <p class="text-muted mb-0">
              <%= isClient
                ? 'Nu exista proiecte asociate contului tau in acest moment.'
                : 'Nu ai proiecte alocate in prezent.'
              %>
            </p>
            <% } else { %>
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th scope="col">Titlu</th>
                    <th scope="col">Status</th>
                    <th scope="col">Deadline</th>
                    <th scope="col">Coordonare</th>
                    <th scope="col" class="text-end">Actiuni</th>
                  </tr>
                </thead>
                <tbody>
                  <% projects.forEach((project) => { %>
                  <tr>
                    <td>
                      <div class="fw-semibold"><%= project.title %></div>
                      <div class="small text-muted"><%= project.degree_level %></div>
                    </td>
                    <td>
                      <span class="badge bg-info text-dark"><%= projectStatusLabels[project.status] || project.status %></span>
                    </td>
                    <td class="text-muted">
                      <%= project.deadline?.toISOString
                        ? project.deadline.toISOString().slice(0, 10)
                        : project.deadline?.toString() || '—' %>
                    </td>
                    <td>
                      <% if (isClient) { %>
                      <div class="small text-muted">Administrator: <%= project.assigned_admin_name || 'Nealocat' %></div>
                      <div class="small text-muted">Redactor: <%= project.assigned_redactor_name || 'Nealocat' %></div>
                      <% } else if (isManager) { %>
                      <div class="small text-muted">Client: <%= project.client_name || 'N/A' %></div>
                      <div class="small text-muted">Redactor: <%= project.assigned_redactor_name || 'Nealocat' %></div>
                      <% } else if (currentUser.role === 'redactor') { %>
                      <div class="small text-muted">Client: <%= project.client_name || 'N/A' %></div>
                      <% } %>
                    </td>
                    <td class="text-end">
                      <a class="btn btn-sm btn-outline-primary" href="/cont/proiecte/<%= project.id %>">Vezi detalii</a>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <div
        class="tab-pane fade <%= currentTab === 'security' ? 'show active' : '' %>"
        id="tab-security"
        role="tabpanel"
        aria-labelledby="tab-security-tab"
        tabindex="0"
      >
        <% const savedDevices = Array.isArray(trustedDevices) ? trustedDevices : []; %>
        <% const savedPasskeys = Array.isArray(passkeys) ? passkeys : []; %>
        <% const activePasskeyTotal =
          typeof activePasskeyCount === 'number'
            ? activePasskeyCount
            : savedPasskeys.filter((passkey) => passkey.status === 'active').length; %>
        <% const activeTrustedDeviceId =
          typeof currentTrustedDeviceId !== 'undefined' && currentTrustedDeviceId !== null
            ? Number(currentTrustedDeviceId)
            : null; %>
        <% const truncate = (value, length = 120) => {
          if (!value) return null;
          return value.length > length ? `${value.slice(0, length)}…` : value;
        }; %>
        <% if (alerts.passwordSuccess) { %>
        <div class="alert alert-success mb-4"><%= alerts.passwordSuccess %></div>
        <% } %>
        <% if (alerts.passwordError) { %>
        <div class="alert alert-danger mb-4"><%= alerts.passwordError %></div>
        <% } %>
        <% if (alerts.deviceSuccess) { %>
        <div class="alert alert-success mb-4"><%= alerts.deviceSuccess %></div>
        <% } %>
        <% if (alerts.deviceError) { %>
        <div class="alert alert-danger mb-4"><%= alerts.deviceError %></div>
        <% } %>
        <% if (alerts.passkeySuccess) { %>
        <div class="alert alert-success mb-4">
          <div class="fw-semibold"><%= alerts.passkeySuccess %></div>
        </div>
        <% } %>
        <% if (alerts.passkeyError) { %>
        <div class="alert alert-danger mb-4"><%= alerts.passkeyError %></div>
        <% } %>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="mb-4">
              <h2 class="h5 mb-1">Schimba parola</h2>
              <p class="text-muted mb-0">Alege o parola puternica pentru a proteja accesul la proiecte si documente.</p>
            </div>
            <form action="/cont/setari/parola" method="post" class="vstack gap-3">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <div>
                <label class="form-label" for="currentPassword">Parola curenta</label>
                <input class="form-control" type="password" id="currentPassword" name="currentPassword" required />
              </div>
            <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="newPassword">Parola noua</label>
                  <input class="form-control" type="password" id="newPassword" name="newPassword" minlength="8" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="confirmPassword">Confirma parola noua</label>
                  <input
                    class="form-control"
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    minlength="8"
                    required
                  />
                </div>
              </div>
              <div class="text-end">
                <button class="btn btn-outline-primary" type="submit">Actualizeaza parola</button>
              </div>
            </form>
          </div>
        </div>
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3 mb-3">
              <div>
                <h2 class="h5 mb-1">Passkey-uri</h2>
                <p class="text-muted mb-0">
                  Creeaza o cheie de acces securizata pentru autentificare fara parola. Poti avea maxim <%= passkeyLimit %>
                  passkey-uri active.
                </p>
              </div>
              <% if (activePasskeyTotal < passkeyLimit) { %>
              <div class="d-flex gap-2 align-items-center">
                <input
                  class="form-control"
                  type="text"
                  id="passkey-name"
                  name="name"
                  placeholder="Ex: Laptop birou"
                  maxlength="150"
                />
                <button class="btn btn-outline-primary btn-sm" type="button" id="btn-create-passkey">Genereaza passkey</button>
              </div>
              <% } %>
            </div>
            <div id="passkey-status" class="small text-muted"></div>
            <% if (savedPasskeys.length) { %>
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">Nume</th>
                    <th scope="col">Status</th>
                    <th scope="col">Ultima utilizare</th>
                    <th scope="col" class="text-end">Actiuni</th>
                  </tr>
                </thead>
                <tbody>
                  <% savedPasskeys.forEach((passkey) => { %>
                  <tr>
                    <td>
                      <div class="fw-semibold"><%= passkey.name %></div>
                      <div class="text-muted small">Creat: <%= formatDateTime(passkey.createdAt) %></div>
                    </td>
                    <td class="text-nowrap">
                      <% const badgeClass = passkey.status === 'active' ? 'bg-success' : 'bg-secondary'; %>
                      <span class="badge <%= badgeClass %>"><%= passkey.status === 'active' ? 'Activ' : 'Revocat' %></span>
                      <% if (passkey.revokedAt) { %>
                      <div class="text-muted small">Revocat: <%= formatDateTime(passkey.revokedAt) %></div>
                      <% } %>
                    </td>
                    <td><%= passkey.lastUsedAt ? formatDateTime(passkey.lastUsedAt) : 'Nu a fost utilizat' %></td>
                    <td class="text-end">
                      <% if (!passkey.revokedAt) { %>
                      <form action="/cont/setari/passkeys" method="post" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                        <input type="hidden" name="action" value="revoke" />
                        <input type="hidden" name="passkeyId" value="<%= passkey.id %>" />
                        <button class="btn btn-sm btn-outline-danger" type="submit">Revoca</button>
                      </form>
                      <% } else { %>
                      <span class="text-muted small">Nu mai este activ</span>
                      <% } %>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
            <% } else { %>
            <p class="text-muted mb-0">Nu ai inca passkey-uri generate pentru autentificare.</p>
            <% } %>
          </div>
        </div>
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3 mb-3">
              <div>
                <h2 class="h5 mb-1">Dispozitive de incredere</h2>
                <p class="text-muted mb-0">Controleaza dispozitivele din care se poate recrea automat sesiunea ta.</p>
              </div>
              <% if (savedDevices.length) { %>
              <div class="d-flex flex-column flex-md-row gap-2">
                <form action="/cont/setari/dispozitive" method="post">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                  <input type="hidden" name="action" value="revoke_all" />
                  <button class="btn btn-outline-danger btn-sm" type="submit">Revoca toate dispozitivele</button>
                </form>
                <% if (savedDevices.length > 1) { %>
                <form action="/cont/setari/dispozitive" method="post">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                  <input type="hidden" name="action" value="revoke_all_except_current" />
                  <button class="btn btn-outline-secondary btn-sm" type="submit">Pastreaza doar acest dispozitiv</button>
                </form>
                <% } %>
              </div>
              <% } %>
            </div>
            <% if (savedDevices.length) { %>
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">Dispozitiv</th>
                    <th scope="col">Activitate</th>
                    <th scope="col">Context</th>
                    <th scope="col" class="text-end">Actiuni</th>
                  </tr>
                </thead>
                <tbody>
                  <% savedDevices.forEach((device) => { %>
                  <% const isCurrent = activeTrustedDeviceId && activeTrustedDeviceId === device.id; %>
                  <tr class="align-top">
                    <td style="min-width: 240px;">
                      <div class="fw-semibold"><%= device.label || 'Dispozitiv salvat' %></div>
                      <div class="text-muted small text-break">
                        <%= truncate(device.userAgent, 140) || 'Agent utilizator indisponibil' %>
                      </div>
                      <% if (device.clientHints) { %>
                      <div class="text-muted small text-break">Client hints: <%= truncate(device.clientHints, 160) %></div>
                      <% } %>
                      <% if (isCurrent) { %>
                      <span class="badge bg-primary-subtle text-primary mt-2">Dispozitiv curent</span>
                      <% } %>
                    </td>
                    <td style="min-width: 200px;">
                      <div class="fw-semibold">Ultima activitate: <%= formatDateTime(device.lastUsedAt) %></div>
                      <div class="text-muted small">Creat: <%= formatDateTime(device.createdAt) %></div>
                      <div class="text-muted small">Expira: <%= formatDateTime(device.expiresAt) %></div>
                    </td>
                    <td style="min-width: 220px;">
                      <div class="fw-semibold">IP: <%= device.ipAddress || '—' %></div>
                      <% if (device.acceptLanguage) { %>
                      <div class="text-muted small">Limba: <%= device.acceptLanguage %></div>
                      <% } %>
                      <% if (device.fingerprint) { %>
                      <div class="text-muted small text-break">Amprenta: <%= truncate(device.fingerprint, 160) %></div>
                      <% } %>
                    </td>
                    <td class="text-end">
                      <form action="/cont/setari/dispozitive" method="post" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                        <input type="hidden" name="action" value="revoke" />
                        <input type="hidden" name="deviceId" value="<%= device.id %>" />
                        <button class="btn btn-sm btn-outline-danger" type="submit">
                          <%= isCurrent ? 'Revoca acest dispozitiv' : 'Revoca' %>
                        </button>
                      </form>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
            <% } else { %>
            <p class="text-muted mb-0">Nu exista inca dispozitive salvate pentru autentificare rapida.</p>
            <% } %>
          </div>
        </div>
        <div class="alert alert-info mt-4 mb-0">
          <p class="mb-1 fw-semibold">Recomandari de securitate</p>
          <ul class="mb-0 small ps-3">
            <li>Foloseste o parola unica, cu minim 12 caractere, litere mari si mici, cifre si simboluri.</li>
            <li>Schimba parola periodic si evita reutilizarea aceleiasi parole pe alte platforme.</li>
            <li>Nu partaja datele de autentificare si deconecteaza-te dupa utilizarea pe dispozitive publice.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const createPasskeyButton = document.getElementById('btn-create-passkey');
    const nameInput = document.getElementById('passkey-name');
    const statusElement = document.getElementById('passkey-status');

    const setStatus = (message, variant = 'muted') => {
      if (!statusElement) return;
      statusElement.textContent = message || '';
      statusElement.className = `small text-${variant}`;
    };

    if (!createPasskeyButton || !window.SimpleWebAuthnBrowser) {
      return;
    }

    createPasskeyButton.addEventListener('click', async () => {
      const label = nameInput?.value?.trim() || '';
      const query = new URLSearchParams();
      if (label) {
        query.set('name', label);
      }

      setStatus('Pregatim inregistrarea passkey-ului...');
      createPasskeyButton.disabled = true;

      try {
        const optionsResponse = await fetch(
          `/cont/setari/passkeys/generate-options${query.toString() ? `?${query.toString()}` : ''}`,
          {
            headers: {
              Accept: 'application/json',
              'X-CSRF-Token': '<%= csrfToken %>'
            }
          }
        );

        if (!optionsResponse.ok) {
          throw new Error('Nu am putut obtine optiunile de inregistrare.');
        }

        const options = await optionsResponse.json();
        const credential = await window.SimpleWebAuthnBrowser.startRegistration(options);

        const verifyResponse = await fetch('/cont/setari/passkeys/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '<%= csrfToken %>'
          },
          body: JSON.stringify({ credential, name: label })
        });

        if (!verifyResponse.ok) {
          throw new Error('Verificarea passkey-ului a esuat.');
        }

        window.location.href = '/cont/setari?success=passkey&tab=security';
      } catch (error) {
        console.error('Nu am putut genera passkey-ul', error);
        setStatus('Nu am putut finaliza inregistrarea passkey-ului. Te rugam sa reincerci.', 'danger');
      } finally {
        createPasskeyButton.disabled = false;
      }
    });
  });
</script>
<%- include('../partials/footer') %>
