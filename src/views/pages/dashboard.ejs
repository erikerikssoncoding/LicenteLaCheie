<%- include('../partials/head', { title, description, request }) %>
<%- include('../partials/header') %>
<section class="py-5">
  <div class="container">
    <style>
      .attention-ticket-scroll {
        max-height: 320px;
        overflow-y: auto;
      }
      .dashboard-scrollable {
        max-height: 320px;
        overflow-y: auto;
      }
      @media (min-width: 992px) {
        .attention-ticket-scroll {
          max-height: 420px;
        }
        .dashboard-scrollable {
          max-height: 420px;
        }
      }
    </style>
    <% const isClient = currentUser.role === 'client'; %>
    <% const isRedactor = currentUser.role === 'redactor'; %>
    <% const isManager = ['admin', 'superadmin'].includes(currentUser.role); %>
    <% const licenseRestricted = Boolean(typeof isLicenseRestricted !== 'undefined' ? isLicenseRestricted : false); %>
    <% const staffLinksDisabled = licenseRestricted && currentUser.role !== 'superadmin'; %>
    <% const projectStatusLabelsMap = Object.fromEntries(
      (projectStatuses || []).map((status) => [status.id, status.label])
    ); %>
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3">Bun venit, <%= currentUser.fullName %></h1>
        <p class="text-muted mb-1">Rol: <span class="badge bg-secondary text-uppercase"><%= currentUser.role %></span></p>
        <% if (currentUser.role === 'admin' && licenseState?.paidUntilDisplay) { %>
        <p class="text-muted small mb-0">Licență plătită până pe <span class="fw-semibold"><%= licenseState.paidUntilDisplay %></span></p>
        <% } %>
      </div>
      <% if (isManager) { %>
      <a
        class="btn btn-primary <%= staffLinksDisabled ? 'disabled' : '' %>"
        href="<%= staffLinksDisabled ? '#' : '/cont/proiecte/creeaza' %>"
        <%= staffLinksDisabled ? 'tabindex="-1" aria-disabled="true"' : '' %>
      >
        Creează proiect
      </a>
      <% } %>
    </div>

    <% if (licenseRestricted) { %>
    <div class="alert alert-warning d-flex flex-column flex-lg-row align-items-start gap-3 mb-4" role="alert">
      <div>
        <h2 class="h6 mb-1 text-warning-emphasis">Licența platformei a expirat</h2>
        <p class="mb-2 small text-muted">
          Funcționalitățile echipei sunt limitate până la reînnoirea licenței. Contactează un superadmin pentru a reactiva accesul complet.
        </p>
        <ul class="mb-0 small ps-3">
          <li>Nu poți accesa detaliile tichetelor sau răspunde în conversații.</li>
          <li>Nu poți deschide proiectele alocate pentru a vedea timeline-ul sau fișierele.</li>
          <li>Nu poți crea proiecte noi sau converti tichete în proiecte.</li>
          <li>Actualizarea statusurilor proiectelor și tichetelor este blocată.</li>
          <li>Încărcarea și gestionarea fișierelor de proiect este dezactivată.</li>
        </ul>
      </div>
      <% if (licenseState?.paidUntilDisplay) { %>
      <div class="ms-lg-auto small text-muted">
        <span class="d-block">Licența a fost activă până la</span>
        <span class="fw-semibold text-dark"><%= licenseState.paidUntilDisplay %></span>
      </div>
      <% } %>
    </div>
    <% } %>

    <% if (isClient) { %>
    <div class="row g-4 mb-4">
      <div class="col-lg-4 col-md-6">
        <%- include('../partials/dashboard/cards/summary-card', {
          title: 'Următorul deadline',
          badge: clientHighlights.nextDeadline ? clientHighlights.nextDeadline.deadline?.toISOString ? clientHighlights.nextDeadline.deadline.toISOString().slice(0,10) : clientHighlights.nextDeadline.deadline : null,
          items: clientHighlights.nextDeadline
            ? [{
                title: clientHighlights.nextDeadline.title,
                subtitle: clientHighlights.nextDeadline.admin_name
                  ? `Administrator: ${clientHighlights.nextDeadline.admin_name}`
                  : clientHighlights.nextDeadline.redactor_name
                  ? `Redactor: ${clientHighlights.nextDeadline.redactor_name}`
                  : 'Deadline confirmat'
              }]
            : [],
          emptyMessage: 'Nu există un deadline stabilit.'
        }) %>
      </div>
      <div class="col-lg-4 col-md-6">
        <%- include('../partials/dashboard/cards/summary-card', {
          title: 'Echipă alocată',
          badge: `${clientHighlights.admins.length + clientHighlights.redactors.length} membri`,
          items: [
            ...clientHighlights.admins.map((member) => ({
              title: member.full_name,
              subtitle: 'Administrator dedicat'
            })),
            ...clientHighlights.redactors.map((member) => ({
              title: member.full_name,
              subtitle: 'Redactor asignat'
            }))
          ],
          emptyMessage: 'Încă nu a fost alocată o echipă.'
        }) %>
      </div>
      <% const offerStatusLabels = {
        pending: 'În pregătire',
        sent: 'Trimisă',
        accepted: 'Acceptată',
        refused: 'Refuzată',
        expired: 'Expirată',
        counter_pending: 'Contraofertă în așteptare',
        counter_submitted: 'Contraofertă trimisă'
      }; %>
      <div class="col-lg-4 col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0">Ofertele tale</h2>
              <a class="btn btn-sm btn-outline-primary" href="/cont/tichete/creeaza">Deschide ticket</a>
            </div>
            <% if (!offers || offers.length === 0) { %>
            <p class="text-muted mb-0">Nu există oferte active.</p>
            <% } else { %>
            <ul class="list-group list-group-flush">
              <% offers.slice(0, 3).forEach((offer) => { %>
              <li class="list-group-item">
                <div class="fw-semibold">Oferta <%= offer.offer_code %></div>
                <div class="small text-muted">Status: <%= offerStatusLabels[offer.status] || offer.status %></div>
                <a class="btn btn-sm btn-link px-0" href="/cont/tichete/<%= offer.ticket_id %>">Deschide ticket</a>
              </li>
              <% }) %>
            </ul>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <% if (isRedactor) { %>
    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <%- include('../partials/dashboard/cards/status-card', {
          title: 'Starea proiectelor',
          statuses: redactorHighlights.statusCounts.map((item) => ({
            label: item.status,
            total: item.total
          })),
          emptyMessage: 'Nu ai proiecte asignate momentan.'
        }) %>
      </div>
      <div class="col-lg-6">
        <%- include('../partials/dashboard/cards/summary-card', {
          title: 'Livrări apropiate',
          badge: redactorHighlights.upcomingDeadlines.length ? `${redactorHighlights.upcomingDeadlines.length} proiecte` : null,
          items: redactorHighlights.upcomingDeadlines.map((project) => ({
            title: project.title,
            subtitle: project.deadline?.toISOString ? project.deadline.toISOString().slice(0,10) : project.deadline
          })),
          emptyMessage: 'Nu sunt livrări în perioada următoare.'
        }) %>
      </div>
    </div>
    <% } %>

    <% if (isManager) { %>
    <div class="row g-4 mb-4">
      <div class="col-xl-6">
        <%- include('../partials/dashboard/cards/status-card', {
          title: 'Proiecte pe status',
          statuses: adminHighlights.statusCounts.map((item) => ({
            label: item.status,
            total: item.total
          })),
          emptyMessage: 'Nu există proiecte în portofoliul tău.'
        }) %>
      </div>
      <div class="col-xl-6">
        <%- include('../partials/dashboard/cards/summary-card', {
          title: 'Ultimele proiecte asignate',
          badge: adminHighlights.recentProjects.length ? `${adminHighlights.recentProjects.length} proiecte` : null,
          items: adminHighlights.recentProjects.map((project) => ({
            title: project.title,
            subtitle: `${project.client_name || 'Client nealocat'} • ${project.deadline ? (project.deadline.toISOString ? project.deadline.toISOString().slice(0,10) : project.deadline) : 'Fără deadline'}`
          })),
          emptyMessage: 'Nu ai proiecte alocate recent.'
        }) %>
      </div>
    </div>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Instrumente rapide</h2>
        <p class="text-muted">Accesează rapid zonele dedicate supervizării echipei și a clienților.</p>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-outline-primary" href="/cont/utilizatori">Utilizatori</a>
          <a
            class="btn btn-outline-primary <%= staffLinksDisabled ? 'disabled' : '' %>"
            href="<%= staffLinksDisabled ? '#' : '/cont/tichete' %>"
            <%= staffLinksDisabled ? 'tabindex="-1" aria-disabled="true"' : '' %>
          >
            Tichete
          </a>
          <a
            class="btn btn-outline-primary <%= staffLinksDisabled ? 'disabled' : '' %>"
            href="<%= staffLinksDisabled ? '#' : '/cont/proiecte/creeaza' %>"
            <%= staffLinksDisabled ? 'tabindex="-1" aria-disabled="true"' : '' %>
          >
            Creează proiect
          </a>
          <a
            class="btn btn-outline-primary <%= staffLinksDisabled ? 'disabled' : '' %>"
            href="<%= staffLinksDisabled ? '#' : '/cont' %>"
            <%= staffLinksDisabled ? 'tabindex="-1" aria-disabled="true"' : '' %>
          >
            Vizualizează proiectele active
          </a>
        </div>
      </div>
    </div>
    <% if (currentUser.role === 'superadmin') { %>
    <div class="card shadow-sm mb-4" id="securitate">
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 mb-3">
          <div>
            <h2 class="h5 mb-1">Securitate platformă</h2>
            <p class="text-muted mb-0">Activează sau dezactivează politicile critice de protecție pentru aplicație.</p>
          </div>
          <% if (securityFlash) { %>
          <div class="flex-shrink-0">
            <div class="alert <%= securityFlash.type === 'success' ? 'alert-success' : 'alert-danger' %> mb-0" role="alert">
              <%= securityFlash.message %>
            </div>
          </div>
          <% } %>
        </div>
        <div class="vstack gap-3">
          <form method="post" action="/cont/securitate/licenta" class="border rounded-3 p-3 bg-body-tertiary">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <div class="row g-3 align-items-end">
              <div class="col-lg-6">
                <label class="form-label small text-uppercase text-muted" for="paidUntil">Licență plătită până la</label>
                <input
                  type="date"
                  class="form-control"
                  id="paidUntil"
                  name="paidUntil"
                  value="<%= licenseState?.paidUntilISO || '' %>"
                  min="2023-01-01"
                />
              </div>
              <div class="col-lg-6 text-lg-end">
                <button class="btn btn-outline-primary" type="submit">Actualizează licență</button>
                <p class="small text-muted mt-2 mb-0">
                  Lasă câmpul necompletat și salvează pentru a marca licența ca neplătită.
                </p>
              </div>
            </div>
          </form>
          <% securitySettings.forEach((setting) => { %>
          <form method="post" action="/cont/securitate" class="border rounded-3 p-3 bg-body-tertiary">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <input type="hidden" name="key" value="<%= setting.key %>" />
            <input type="hidden" name="enabled" value="<%= setting.isEnabled ? '0' : '1' %>" />
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
              <div>
                <h3 class="h6 mb-1"><%= setting.label %></h3>
                <p class="small text-muted mb-0"><%= setting.description %></p>
              </div>
              <div class="text-md-end">
                <span class="badge <%= setting.isEnabled ? 'bg-success' : 'bg-secondary' %> mb-2">
                  <%= setting.isEnabled ? 'Activ' : 'Inactiv' %>
                </span>
                <div>
                  <button class="btn <%= setting.isEnabled ? 'btn-outline-danger' : 'btn-outline-success' %>" type="submit">
                    <%= setting.isEnabled ? 'Dezactivează' : 'Activează' %>
                  </button>
                </div>
              </div>
            </div>
          </form>
          <% }) %>
          <form method="post" action="/cont/securitate/test-mail" class="border rounded-3 p-3 bg-body-tertiary">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <% if (currentUser.email) { %>
            <input type="hidden" name="recipient" value="<%= currentUser.email %>" />
            <% } %>
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
              <div>
                <h3 class="h6 mb-1">Test configurare email</h3>
                <p class="small text-muted mb-0">
                  Trimite un email de test folosind setările SMTP din .env
                  <%= currentUser.email ? `către ${currentUser.email}` : '' %>.
                </p>
              </div>
              <div class="text-md-end">
                <button class="btn btn-outline-primary" type="submit">Trimite email de test</button>
              </div>
            </div>
          </form>
          <div class="border rounded-3 p-3 bg-body-tertiary">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
              <div>
                <h3 class="h6 mb-1">Jurnal</h3>
                <p class="small text-muted mb-0">Notificări email și acțiuni de administrare (răspunsuri, modificări, ștergeri).</p>
              </div>
              <span class="badge bg-light text-body-secondary border">maxim 25 intrări recente</span>
            </div>
            <% if (journalEntries && journalEntries.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">Tip</th>
                    <th scope="col">Descriere</th>
                    <th scope="col">Detalii</th>
                    <th scope="col">Rezultat</th>
                    <th scope="col" class="text-end">Data</th>
                  </tr>
                </thead>
                <tbody>
                  <% journalEntries.forEach((entry) => { %>
                  <tr>
                    <td class="text-nowrap">
                      <span class="badge <%= entry.type === 'mail' ? 'bg-secondary' : 'bg-info text-dark' %>">
                        <%= entry.type === 'mail' ? 'Notificare email' : 'Acțiune admin' %>
                      </span>
                    </td>
                    <td style="max-width: 260px">
                      <div class="fw-semibold text-truncate"><%= entry.title %></div>
                      <div class="small text-muted text-truncate"><%= entry.subtitle %></div>
                    </td>
                    <td class="small text-muted" style="max-width: 260px"><%= entry.detail %></td>
                    <td>
                      <span
                        class="badge <%= entry.status === 'sent' || entry.status === 'success'
                          ? 'bg-success'
                          : entry.status === 'skipped'
                            ? 'bg-warning text-dark'
                            : 'bg-danger' %>"
                      >
                        <%= entry.status %>
                      </span>
                      <% if (entry.statusContext) { %>
                      <div class="small text-muted"><%= entry.statusContext %></div>
                      <% } %>
                    </td>
                    <td class="text-end"><%= formatDateTime(entry.createdAt) %></td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } else { %>
            <p class="mb-0 text-muted">Nu există acțiuni sau notificări înregistrate încă.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% } %>
    <% } %>

    <div class="row g-4 mb-4">
      <% if (pendingSupportTickets && pendingSupportTickets.length > 0) { %>
      <div class="col-lg-6 col-xl-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h2 class="h6 mb-3">Tichete ce necesita atentie</h2>
            <div class="attention-ticket-scroll">
              <ul class="list-group list-group-flush mb-0">
                <% pendingSupportTickets.forEach((ticket) => { %>
                <li class="list-group-item">
                  <div class="fw-semibold"><%= ticket.subject %></div>
                  <div class="small text-muted">Cod: <%= ticket.display_code %> • Status: <%= ticket.status === 'rezolvat' && ticket.merged_into_ticket_id ? 'rezolvat (merged)' : ticket.status %></div>
                  <a
                    class="btn btn-sm btn-link px-0 <%= licenseRestricted ? 'disabled' : '' %>"
                    href="<%= licenseRestricted ? '#' : `/cont/tichete/${ticket.id}` %>"
                    <%= licenseRestricted ? 'tabindex=\"-1\" aria-disabled=\"true\"' : '' %>
                  >
                    Gestioneaza
                  </a>
                </li>
                <% }) %>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <% } %>

      <% if (pendingOffers && pendingOffers.length > 0) { %>
      <div class="col-lg-6 col-xl-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h2 class="h6 mb-3">Oferte în așteptare</h2>
            <ul class="list-group list-group-flush">
              <% pendingOffers.forEach((offer) => { %>
              <li class="list-group-item">
                <div class="fw-semibold"><%= offer.client_name_full || offer.client_name %></div>
                <div class="small text-muted">Solicitare <%= offer.offer_code %> – Ticket <%= offer.ticket_display_code || 'N/A' %> – status <%= offer.status %></div>
                <a
                  class="btn btn-sm btn-link px-0 <%= licenseRestricted ? 'disabled' : '' %>"
                  href="<%= licenseRestricted ? '#' : `/cont/tichete/${offer.ticket_id}` %>"
                  <%= licenseRestricted ? 'tabindex=\"-1\" aria-disabled=\"true\"' : '' %>
                >
                  Deschide ticket
                </a>
              </li>
              <% }) %>
            </ul>
          </div>
        </div>
      </div>
      <% } %>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0">
                <%= isClient ? 'Proiectele tale' : isRedactor ? 'Proiecte asignate' : 'Proiecte coordonate' %>
              </h2>
              <% if (isClient) { %>
              <a class="btn btn-sm btn-outline-primary" href="/cont/tichete/creeaza">Deschide ticket</a>
              <% } %>
            </div>
            <% if (projects.length === 0) { %>
            <p class="text-muted">
              <%= isClient
                ? 'Momentan nu există proiecte active.'
                : isRedactor
                ? 'Nu ai proiecte asignate în acest moment.'
                : 'Nu există proiecte în portofoliul tău momentan.'
              %>
            </p>
            <% } else { %>
            <div class="table-responsive dashboard-scrollable">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Titlu</th>
                    <th>Status</th>
                    <th><%= isClient ? 'Responsabil' : 'Coordonare' %></th>
                    <th>Deadline</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% projects.forEach((project) => { %>
                  <tr>
                    <td>
                      <div class="fw-semibold"><%= project.title %></div>
                      <div class="small text-muted"><%= project.degree_level %></div>
                    </td>
                    <td>
                      <span class="badge bg-info text-dark text-uppercase">
                        <%= projectStatusLabelsMap[project.status] || project.status %>
                      </span>
                    </td>
                    <td class="small">
                      <% if (isClient) { %>
                      <div>Admin: <%= project.assigned_admin_name || 'In alocare' %></div>
                      <div>Redactor: <%= project.assigned_redactor_name || 'In alocare' %></div>
                      <% } else if (isRedactor) { %>
                      <div>Client: <%= project.client_name %></div>
                      <% } else { %>
                      <div>Client: <%= project.client_name %></div>
                      <div>Redactor: <%= project.assigned_redactor_name || 'Nealocat' %></div>
                      <% } %>
                    </td>
                    <td><%= project.deadline ? project.deadline.toISOString ? project.deadline.toISOString().slice(0,10) : project.deadline : 'N/A' %></td>
                    <td class="text-end">
                      <a
                        class="btn btn-sm btn-outline-secondary <%= staffLinksDisabled ? 'disabled' : '' %>"
                        href="<%= staffLinksDisabled ? '#' : `/cont/proiecte/${project.id}` %>"
                        <%= staffLinksDisabled ? 'tabindex="-1" aria-disabled="true"' : '' %>
                      >
                        Detalii
                      </a>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } %>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h2 class="h5">Tichete recente</h2>
            <% if (tickets.length === 0) { %>
            <p class="text-muted">Nu exista tichete deschise.</p>
            <% } else { %>
            <div class="dashboard-scrollable pe-1">
              <ul class="list-group list-group-flush">
                <% tickets.slice(0, 5).forEach((ticket) => { %>
                <li class="list-group-item">
                  <div class="fw-semibold"><%= ticket.subject %></div>
                  <div class="small text-muted">Cod: <%= ticket.display_code %> • Tip: <%= ticket.kind %> • Status: <%= ticket.status === 'rezolvat' && ticket.merged_into_ticket_id ? 'rezolvat (merged)' : ticket.status %></div>
                  <a
                    class="btn btn-sm btn-link px-0 <%= licenseRestricted ? 'disabled' : '' %>"
                    href="<%= licenseRestricted ? '#' : `/cont/tichete/${ticket.id}` %>"
                    <%= licenseRestricted ? 'tabindex=\"-1\" aria-disabled=\"true\"' : '' %>
                  >
                    Vezi ticket
                  </a>
                </li>
                <% }) %>
              </ul>
            </div>
            <% } %>
            <% if (recentReplies && recentReplies.length > 0) { %>
            <div class="mt-4">
              <h3 class="h6">Raspunsuri noi</h3>
              <ul class="list-unstyled mb-0">
                <% recentReplies.forEach((reply) => { %>
                <li class="mb-2 small">
                  <strong><%= reply.subject %></strong> – actualizat recent
                </li>
                <% }) %>
              </ul>
            </div>
            <% } %>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>
<%- include('../partials/footer') %>
