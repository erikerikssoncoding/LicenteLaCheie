<%- include('../partials/head', { title, description, request }) %>
<%- include('../partials/header') %>
<section class="py-5 py-lg-6">
  <div class="container" style="max-width: 820px;">
    <div class="glass-card mb-4">
      <h1 class="h4 mb-3"><%= ticket.subject %></h1>
      <p class="text-muted">Status: <span class="badge text-bg-info text-dark text-uppercase"><%= ticket.status %></span></p>
      <% if (ticket.project_title) { %>
      <p class="mb-0">Proiect: <strong><%= ticket.project_title %></strong></p>
      <% } %>
    </div>

    <% if (feedback && feedback.success) { %>
    <div class="alert alert-success"><%= feedback.success %></div>
    <% } %>
    <% if (feedback && feedback.error) { %>
    <div class="alert alert-danger"><%= feedback.error %></div>
    <% } %>

    <% if (offer) { %>
    <% const offerExpires = offer.expires_at
      ? (offer.expires_at.toISOString ? offer.expires_at.toISOString().replace('T', ' ').slice(0, 16) : offer.expires_at)
      : 'N/A'; %>
    <% const counterExpires = offer.counter_expires_at
      ? (offer.counter_expires_at.toISOString
          ? offer.counter_expires_at.toISOString().replace('T', ' ').slice(0, 16)
          : offer.counter_expires_at)
      : null; %>
    <% const offerStatusLabels = {
      pending: 'In pregatire',
      sent: 'Trimisa',
      accepted: 'Acceptata',
      refused: 'Refuzata',
      expired: 'Expirata',
      counter_pending: 'Contraoferta in asteptare',
      counter_submitted: 'Contraoferta trimisa'
    }; %>
    <div class="glass-card mb-4">
      <h2 class="h5 mb-3">Oferta personalizata</h2>
      <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
        <span class="badge bg-primary text-uppercase"><%= offerStatusLabels[offer.status] || offer.status %></span>
        <% if (offer.offer_amount) { %>
        <span class="fw-semibold">Valoare propusa: <%= Number(offer.offer_amount).toFixed(2) %> EUR</span>
        <% } else { %>
        <span class="fw-semibold text-muted">Valoarea este in curs de stabilire</span>
        <% } %>
      </div>
      <dl class="row mb-0">
        <dt class="col-sm-4">Valabil pana la</dt>
        <dd class="col-sm-8"><%= offerExpires %></dd>
        <% if (offer.notes) { %>
        <dt class="col-sm-4">Mesaj administrator</dt>
        <dd class="col-sm-8"><%= offer.notes %></dd>
        <% } %>
        <% if (offer.status === 'counter_submitted') { %>
        <dt class="col-sm-4">Contraoferta client</dt>
        <dd class="col-sm-8"><%= Number(offer.counter_amount).toFixed(2) %> EUR</dd>
        <% } %>
        <% if (offer.status === 'counter_pending' && counterExpires) { %>
        <dt class="col-sm-4">Contraoferta in asteptare</dt>
        <dd class="col-sm-8">Valabila pana la <%= counterExpires %></dd>
        <% } %>
      </dl>
    </div>

    <% if (['admin', 'superadmin'].includes(currentUser.role)) { %>
    <% if (!offer.offer_amount) { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Trimite oferta catre client</h3>
      <form action="/cont/tichete/<%= ticket.id %>/oferta/detalii" method="post" class="row g-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="col-md-4">
          <label class="form-label" for="offerAmount">Valoare oferta (EUR)</label>
          <input class="form-control" type="number" step="0.01" min="0" id="offerAmount" name="amount" required />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="offerExpires">Valabilitate (ore)</label>
          <input class="form-control" type="number" min="<%= offerMinHours %>" id="offerExpires" name="expiresInHours" value="<%= offerMinHours %>" />
          <small class="text-muted">Minim <%= offerMinHours %> ore.</small>
        </div>
        <div class="col-12">
          <label class="form-label" for="offerMessage">Mesaj pentru client</label>
          <textarea class="form-control" id="offerMessage" name="message" rows="2"><%= offer.notes || '' %></textarea>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary" type="submit">Trimite oferta</button>
        </div>
      </form>
    </div>
    <% } else { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Detalii oferta transmisa</h3>
      <p class="mb-1">Valoare initiala: <strong><%= Number(offer.offer_amount).toFixed(2) %> EUR</strong></p>
      <p class="mb-2">Valabila pana la: <strong><%= offerExpires %></strong></p>
      <% if (offer.notes) { %>
      <p class="mb-2">Mesaj catre client: <%= offer.notes %></p>
      <% } %>
      <div class="alert alert-info mb-0">Valoarea si valabilitatea ofertei nu mai pot fi modificate dupa transmiterea initiala.</div>
    </div>
    <% } %>
    <% if (offer.status === 'counter_submitted') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Raspunde la contraoferta clientului</h3>
      <p class="mb-3">Clientul propune <strong><%= Number(offer.counter_amount).toFixed(2) %> EUR</strong>.</p>
      <div class="d-flex flex-column flex-sm-row gap-3">
        <form action="/cont/tichete/<%= ticket.id %>/oferta/contraoferta/accepta" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button class="btn btn-success" type="submit">Accepta contraoferta</button>
        </form>
        <form action="/cont/tichete/<%= ticket.id %>/oferta/contraoferta/refuza" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button class="btn btn-outline-danger" type="submit">Refuza contraoferta</button>
        </form>
      </div>
    </div>
    <% } %>
    <% if (offer.status === 'accepted' && ticket.kind !== 'contract') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Porneste semnarea contractului</h3>
      <p class="text-muted">Activeaza formularul pentru ca beneficiarul sa-si completeze datele personale.</p>
      <form action="/cont/tichete/<%= ticket.id %>/oferta/contract" method="post" class="d-flex flex-column flex-sm-row gap-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <button class="btn btn-primary" type="submit">Activeaza semnarea contractului</button>
      </form>
    </div>
    <% } %>
    <% } %>

    <% if (currentUser.role === 'client') { %>
    <% if (offer.status === 'sent') { %>
    <div class="glass-card mb-4">
      <div class="d-flex flex-column flex-sm-row gap-3">
        <form action="/cont/tichete/<%= ticket.id %>/oferta/accepta" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button class="btn btn-success" type="submit">Accepta oferta</button>
        </form>
        <form action="/cont/tichete/<%= ticket.id %>/oferta/refuza" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button class="btn btn-outline-danger" type="submit">Refuza oferta</button>
        </form>
      </div>
    </div>
    <% } %>

    <% if (offer.status === 'counter_pending') { %>
    <div class="glass-card mb-4">
      <h3 class="h6">Trimite contraoferta</h3>
      <p class="text-muted">Completeaza valoarea dorita in maxim 30 de minute pentru a continua negocierea.</p>
      <form action="/cont/tichete/<%= ticket.id %>/oferta/contraoferta" method="post" class="d-flex flex-column flex-sm-row gap-3 align-items-sm-end">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="flex-grow-1 w-100">
          <label class="form-label" for="counterAmount">Propune valoare (EUR)</label>
          <input class="form-control" type="number" step="0.01" min="0" id="counterAmount" name="amount" required />
        </div>
        <button class="btn btn-outline-primary" type="submit">Trimite contraoferta</button>
      </form>
    </div>
    <% } %>
    <% } %>
    <% if (ticket.kind === 'contract' && currentUser.role === 'client') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Completeaza datele pentru contract</h3>
      <p class="text-muted"><span class="text-success">ðŸ”’</span> Datele de pe buletin sunt salvate criptat si sunt folosite exclusiv pentru generarea contractului.</p>
      <form action="/cont/tichete/<%= ticket.id %>/contract-date" method="post" class="row g-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="col-12">
          <label class="form-label" for="contractFullName">Nume complet</label>
          <input
            class="form-control"
            type="text"
            id="contractFullName"
            name="fullName"
            value="<%= contractDetails?.fullName || currentUser.fullName || '' %>"
            required
          />
        </div>
        <div class="col-md-6">
          <label class="form-label" for="contractIdType">Identificat prin</label>
          <input
            class="form-control"
            type="text"
            id="contractIdType"
            name="idType"
            placeholder="ex: CI seria"
            value="<%= contractDetails?.idType || '' %>"
            required
          />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="contractIdSeries">Seria</label>
          <input
            class="form-control"
            type="text"
            id="contractIdSeries"
            name="idSeries"
            value="<%= contractDetails?.idSeries || '' %>"
            required
          />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="contractIdNumber">Numar</label>
          <input
            class="form-control"
            type="text"
            id="contractIdNumber"
            name="idNumber"
            value="<%= contractDetails?.idNumber || '' %>"
            required
          />
        </div>
        <div class="col-md-6">
          <label class="form-label" for="contractCnp">CNP <span class="text-muted">(optional)</span></label>
          <input
            class="form-control"
            type="text"
            id="contractCnp"
            name="cnp"
            value="<%= contractDetails?.cnp || '' %>"
          />
        </div>
        <div class="col-12">
          <label class="form-label" for="contractAddress">Adresa de domiciliu</label>
          <textarea class="form-control" id="contractAddress" name="address" rows="2" required><%= contractDetails?.address || '' %></textarea>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-success" type="submit">Salveaza datele</button>
        </div>
      </form>
    </div>
    <% } %>
    <% if (['admin', 'superadmin'].includes(currentUser.role) && contractDetails) { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Date contract client</h3>
      <p class="text-success mb-3">ðŸ”’ Date vizibile doar administratorilor autorizati.</p>
      <dl class="row mb-0">
        <dt class="col-sm-4">Nume complet</dt>
        <dd class="col-sm-8"><%= contractDetails.fullName %></dd>
        <dt class="col-sm-4">Identificat prin</dt>
        <dd class="col-sm-8"><%= contractDetails.idType %></dd>
        <dt class="col-sm-4">Seria / Numar</dt>
        <dd class="col-sm-8"><%= contractDetails.idSeries %> / <%= contractDetails.idNumber %></dd>
        <% if (contractDetails.cnp) { %>
        <dt class="col-sm-4">CNP</dt>
        <dd class="col-sm-8"><%= contractDetails.cnp %></dd>
        <% } %>
        <dt class="col-sm-4">Adresa domiciliu</dt>
        <dd class="col-sm-8"><%= contractDetails.address %></dd>
      </dl>
    </div>
    <% } %>
    <% } %>

    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-content">
          <h2 class="h6">Mesaj initial</h2>
          <p><%= ticket.message %></p>
          <small class="text-muted">Creat de <%= ticket.author_name %></small>
        </div>
      </div>
      <% replies.forEach((reply) => { %>
      <div class="timeline-item">
        <div class="timeline-content">
          <h2 class="h6">Raspuns</h2>
          <p><%= reply.message %></p>
          <small class="text-muted">Trimis de <%= reply.author_name %></small>
        </div>
      </div>
      <% }) %>
    </div>

    <div class="glass-card mt-4">
      <form action="/cont/tichete/<%= ticket.id %>/raspuns" method="post" class="vstack gap-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div>
          <label class="form-label" for="message">Adauga raspuns</label>
          <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
        </div>
        <button class="btn btn-gradient align-self-end" type="submit">Trimite raspuns</button>
      </form>
    </div>

    <% if (['admin', 'superadmin'].includes(currentUser.role)) { %>
    <div class="glass-card mt-4">
      <form action="/cont/tichete/<%= ticket.id %>/status" method="post" class="d-flex flex-column flex-sm-row gap-3 align-items-sm-end">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="flex-grow-1 w-100">
          <label class="form-label" for="status">Actualizeaza statusul</label>
          <select class="form-select" id="status" name="status">
            <option value="deschis">Deschis</option>
            <option value="in-analiza">In analiza</option>
            <option value="rezolvat">Rezolvat</option>
          </select>
        </div>
        <button class="btn btn-outline-primary" type="submit">Salveaza</button>
      </form>
    </div>
    <% } %>
  </div>
</section>
<%- include('../partials/footer') %>
