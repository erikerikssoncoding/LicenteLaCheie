<%- include('../partials/head', { title, description, request }) %>
<%- include('../partials/header') %>
<section class="py-5 py-lg-6">
  <div class="container" style="max-width: 820px;">
    <style>
      .contract-preview {
        background-color: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 1rem;
        padding: 2rem;
        overflow-x: auto;
      }
      .contract-document h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      .contract-document__body h2 {
        font-size: 1.05rem;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
      }
      .contract-document__body p,
      .contract-document__body li {
        font-size: 0.95rem;
        line-height: 1.6;
      }
      .contract-document__signatures {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 2rem;
      }
      @media (min-width: 768px) {
        .contract-document__signatures {
          flex-direction: row;
          justify-content: space-between;
        }
      }
      .signature-block {
        flex: 1;
      }
      .signature-box {
        border: 1px dashed #6c757d;
        border-radius: 0.75rem;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        padding: 0.75rem;
      }
      .signature-placeholder {
        color: #6c757d;
        letter-spacing: 0.1em;
      }
      .signature-image {
        max-width: 100%;
        max-height: 110px;
        object-fit: contain;
      }
      .signature-pad-wrapper {
        border: 1px dashed rgba(0, 0, 0, 0.2);
        border-radius: 1rem;
        background: #ffffff;
        padding: 1rem;
      }
      .signature-pad-wrapper canvas {
        width: 100%;
        height: 180px;
        touch-action: none;
        display: block;
      }
    </style>
    <div class="glass-card mb-4">
      <h1 class="h4 mb-3"><%= ticket.subject %></h1>
      <p class="text-muted small mb-2">Cod ticket: <strong><%= ticket.display_code %></strong></p>
      <p class="text-muted">Status: <span class="badge text-bg-info text-dark text-uppercase"><%= ticket.status %></span></p>
      <% if (ticket.project_title) { %>
      <p class="mb-0">Proiect: <strong><%= ticket.project_title %></strong></p>
      <% } %>
    </div>

    <% if (feedback && feedback.success) { %>
    <div class="alert alert-success"><%= feedback.success %></div>
    <% } %>
    <% if (feedback && feedback.error) { %>
    <div class="alert alert-danger"><%= feedback.error %></div>
    <% } %>

    <% if (offer) { %>
    <% const offerExpires = offer.expires_at
      ? (offer.expires_at.toISOString ? offer.expires_at.toISOString().replace('T', ' ').slice(0, 16) : offer.expires_at)
      : 'N/A'; %>
    <% const counterExpires = offer.counter_expires_at
      ? (offer.counter_expires_at.toISOString
          ? offer.counter_expires_at.toISOString().replace('T', ' ').slice(0, 16)
          : offer.counter_expires_at)
      : null; %>
    <% const offerStatusLabels = {
      pending: 'In pregatire',
      sent: 'Trimisa',
      accepted: 'Acceptata',
      refused: 'Refuzata',
      expired: 'Expirata',
      counter_pending: 'Contraoferta in asteptare',
      counter_submitted: 'Contraoferta trimisa'
    }; %>
    <div class="glass-card mb-4">
      <h2 class="h5 mb-3">Oferta personalizata</h2>
      <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
        <span class="badge bg-primary text-uppercase"><%= offerStatusLabels[offer.status] || offer.status %></span>
        <% if (offer.offer_amount) { %>
        <span class="fw-semibold">Valoare propusa: <%= Number(offer.offer_amount).toFixed(2) %> EUR</span>
        <% } else { %>
        <span class="fw-semibold text-muted">Valoarea este in curs de stabilire</span>
        <% } %>
      </div>
      <dl class="row mb-0">
        <dt class="col-sm-4">Valabil pana la</dt>
        <dd class="col-sm-8"><%= offerExpires %></dd>
        <% if (offer.notes) { %>
        <dt class="col-sm-4">Mesaj administrator</dt>
        <dd class="col-sm-8"><%= offer.notes %></dd>
        <% } %>
        <% if (offer.status === 'counter_submitted') { %>
        <dt class="col-sm-4">Contraoferta client</dt>
        <dd class="col-sm-8"><%= Number(offer.counter_amount).toFixed(2) %> EUR</dd>
        <% } %>
        <% if (offer.status === 'counter_pending' && counterExpires) { %>
        <dt class="col-sm-4">Contraoferta in asteptare</dt>
        <dd class="col-sm-8">Valabila pana la <%= counterExpires %></dd>
        <% } %>
      </dl>
    </div>

    <% if (['admin', 'superadmin'].includes(currentUser.role)) { %>
    <% if (!offer.offer_amount) { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Trimite oferta catre client</h3>
      <form action="/cont/tichete/<%= ticket.id %>/oferta/detalii" method="post" class="row g-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="col-md-4">
          <label class="form-label" for="offerAmount">Valoare oferta (EUR)</label>
          <input class="form-control" type="number" step="0.01" min="0" id="offerAmount" name="amount" required />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="offerExpires">Valabilitate (ore)</label>
          <input class="form-control" type="number" min="<%= offerMinHours %>" id="offerExpires" name="expiresInHours" value="<%= offerMinHours %>" />
          <small class="text-muted">Minim <%= offerMinHours %> ore.</small>
        </div>
        <div class="col-12">
          <label class="form-label" for="offerMessage">Mesaj pentru client</label>
          <textarea class="form-control" id="offerMessage" name="message" rows="2"><%= offer.notes || '' %></textarea>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary" type="submit">Trimite oferta</button>
        </div>
      </form>
    </div>
    <% } else { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Detalii oferta transmisa</h3>
      <p class="mb-1">Valoare initiala: <strong><%= Number(offer.offer_amount).toFixed(2) %> EUR</strong></p>
      <p class="mb-2">Valabila pana la: <strong><%= offerExpires %></strong></p>
      <% if (offer.notes) { %>
      <p class="mb-2">Mesaj catre client: <%= offer.notes %></p>
      <% } %>
      <div class="alert alert-info mb-0">Valoarea si valabilitatea ofertei nu mai pot fi modificate dupa transmiterea initiala.</div>
    </div>
    <% } %>
    <% if (offer.status === 'counter_submitted') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Raspunde la contraoferta clientului</h3>
      <p class="mb-3">Clientul propune <strong><%= Number(offer.counter_amount).toFixed(2) %> EUR</strong>.</p>
      <div class="d-flex flex-column flex-sm-row gap-3">
        <form action="/cont/tichete/<%= ticket.id %>/oferta/contraoferta/accepta" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button class="btn btn-success" type="submit">Accepta contraoferta</button>
        </form>
        <form action="/cont/tichete/<%= ticket.id %>/oferta/contraoferta/refuza" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button class="btn btn-outline-danger" type="submit">Refuza contraoferta</button>
        </form>
      </div>
    </div>
    <% } %>
    <% if (offer.status === 'accepted' && ticket.kind !== 'contract') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Porneste semnarea contractului</h3>
      <p class="text-muted">Activeaza formularul pentru ca beneficiarul sa-si completeze datele personale.</p>
      <form action="/cont/tichete/<%= ticket.id %>/oferta/contract" method="post" class="d-flex flex-column flex-sm-row gap-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <button class="btn btn-primary" type="submit">Activeaza semnarea contractului</button>
      </form>
    </div>
    <% } %>
    <% } %>

    <% if (currentUser.role === 'client') { %>
    <% if (offer.status === 'sent') { %>
    <div class="glass-card mb-4">
      <div class="d-flex flex-column flex-sm-row gap-3">
        <form action="/cont/tichete/<%= ticket.id %>/oferta/accepta" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button class="btn btn-success" type="submit">Accepta oferta</button>
        </form>
        <form action="/cont/tichete/<%= ticket.id %>/oferta/refuza" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button class="btn btn-outline-danger" type="submit">Refuza oferta</button>
        </form>
      </div>
    </div>
    <% } %>

    <% if (offer.status === 'counter_pending') { %>
    <div class="glass-card mb-4">
      <h3 class="h6">Trimite contraoferta</h3>
      <p class="text-muted">Completeaza valoarea dorita in maxim 30 de minute pentru a continua negocierea.</p>
      <form action="/cont/tichete/<%= ticket.id %>/oferta/contraoferta" method="post" class="d-flex flex-column flex-sm-row gap-3 align-items-sm-end">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="flex-grow-1 w-100">
          <label class="form-label" for="counterAmount">Propune valoare (EUR)</label>
          <input class="form-control" type="number" step="0.01" min="0" id="counterAmount" name="amount" required />
        </div>
        <button class="btn btn-outline-primary" type="submit">Trimite contraoferta</button>
      </form>
    </div>
    <% } %>
    <% } %>
    <% const contractStage = contractDetails?.contractStage || 'pending_data'; %>
    <% const contractStageLabels = {
      pending_data: 'Asteptam completarea datelor pentru contract.',
      draft: 'Draftul contractului este generat. Semneaza-l pentru a continua.',
      awaiting_admin: 'Contract semnat de beneficiar. In asteptare semnatura administrator.',
      completed: 'Contract semnat de ambele parti.'
    }; %>
    <% if (ticket.kind === 'contract') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Status contract</h3>
      <p class="mb-2"><%= contractStageLabels[contractStage] || contractStage %></p>
      <% if (contractDetails?.contractNumber) { %>
      <p class="mb-1">Numar contract: <strong><%= contractDetails.contractNumber %></strong></p>
      <% } %>
      <% if (contractDetails?.contractDate) { %>
      <p class="mb-0">Data contract: <strong><%= contractDetails.contractDate.toISOString ? contractDetails.contractDate.toISOString().slice(0, 10) : contractDetails.contractDate %></strong></p>
      <% } %>
    </div>
    <% } %>
    <% if (ticket.kind === 'contract' && currentUser.role === 'client') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Completeaza datele pentru contract</h3>
      <p class="text-muted"><span class="text-success">ðŸ”’</span> Datele de pe buletin sunt salvate criptat si sunt folosite exclusiv pentru generarea contractului.</p>
      <form action="/cont/tichete/<%= ticket.id %>/contract-date" method="post" class="row g-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="col-12">
          <label class="form-label" for="contractFullName">Nume complet</label>
          <input class="form-control" type="text" id="contractFullName" name="fullName" value="<%= contractDetails?.fullName || currentUser.fullName || '' %>" required />
        </div>
        <div class="col-md-6">
          <label class="form-label" for="contractIdType">Identificat prin</label>
          <input class="form-control" type="text" id="contractIdType" name="idType" placeholder="ex: CI seria" value="<%= contractDetails?.idType || '' %>" required />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="contractIdSeries">Seria</label>
          <input class="form-control" type="text" id="contractIdSeries" name="idSeries" value="<%= contractDetails?.idSeries || '' %>" required />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="contractIdNumber">Numar</label>
          <input class="form-control" type="text" id="contractIdNumber" name="idNumber" value="<%= contractDetails?.idNumber || '' %>" required />
        </div>
        <div class="col-md-6">
          <label class="form-label" for="contractCnp">CNP <span class="text-muted">(optional)</span></label>
          <input class="form-control" type="text" id="contractCnp" name="cnp" value="<%= contractDetails?.cnp || '' %>" />
        </div>
        <div class="col-12">
          <label class="form-label" for="contractAddress">Adresa de domiciliu</label>
          <textarea class="form-control" id="contractAddress" name="address" rows="2" required><%= contractDetails?.address || '' %></textarea>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-success" type="submit">Salveaza datele &amp; Genereaza contractul</button>
        </div>
      </form>
    </div>
    <% } %>
    <% if (ticket.kind === 'contract' && contractDetails?.contractDraft) { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Draft contract</h3>
      <div class="contract-preview">
        <%- contractDetails.contractDraft %>
      </div>
      <% if (['client', 'admin', 'superadmin'].includes(currentUser.role)) { %>
      <form
        action="/cont/tichete/<%= ticket.id %>/contract/descarca"
        method="post"
        class="mt-3 d-flex flex-column flex-md-row align-items-md-center gap-2"
      >
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <button class="btn btn-outline-primary" type="submit">Descarca contractul</button>
        <small class="text-muted">Link securizat, valabil 10 minute pentru utilizatorii autorizati.</small>
      </form>
      <% } %>
    </div>
    <% } %>
    <% if (ticket.kind === 'contract' && currentUser.role === 'client' && contractStage === 'draft') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Semneaza contractul</h3>
      <p class="text-muted">Semneaza electronic cu degetul sau cu mouse-ul, apoi aplica semnatura pe contract.</p>
      <form action="/cont/tichete/<%= ticket.id %>/contract/semnatura-client" method="post" class="vstack gap-3" data-signature-form>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <input type="hidden" name="signatureData" value="" />
        <div class="signature-pad-wrapper" data-signature-pad>
          <canvas></canvas>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2">
          <button class="btn btn-outline-secondary" type="button" data-signature-clear>Sterge semnatura</button>
          <button class="btn btn-success" type="submit">Aplica pe contract</button>
        </div>
        <p class="text-danger small d-none" data-signature-error>Deseneaza semnatura inainte de a o aplica.</p>
      </form>
    </div>
    <% } %>
    <% if (ticket.kind === 'contract' && ['admin', 'superadmin'].includes(currentUser.role) && contractStage === 'awaiting_admin') { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Semneaza contractul ca administrator</h3>
      <p class="text-muted">Aplica semnatura electronica pentru a finaliza contractul si a genera numarul si data.</p>
      <form action="/cont/tichete/<%= ticket.id %>/contract/semnatura-admin" method="post" class="vstack gap-3" data-signature-form>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <input type="hidden" name="signatureData" value="" />
        <div class="signature-pad-wrapper" data-signature-pad>
          <canvas></canvas>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2">
          <button class="btn btn-outline-secondary" type="button" data-signature-clear>Sterge semnatura</button>
          <button class="btn btn-primary" type="submit">Aplica pe contract</button>
        </div>
        <p class="text-danger small d-none" data-signature-error>Deseneaza semnatura inainte de a o aplica.</p>
      </form>
    </div>
    <% } %>
    <% if (['admin', 'superadmin'].includes(currentUser.role) && contractDetails) { %>
    <div class="glass-card mb-4">
      <h3 class="h6 mb-3">Date contract client</h3>
      <p class="text-success mb-3">ðŸ”’ Date vizibile doar administratorilor autorizati.</p>
      <dl class="row mb-0">
        <dt class="col-sm-4">Nume complet</dt>
        <dd class="col-sm-8"><%= contractDetails.fullName %></dd>
        <dt class="col-sm-4">Identificat prin</dt>
        <dd class="col-sm-8"><%= contractDetails.idType %></dd>
        <dt class="col-sm-4">Seria / Numar</dt>
        <dd class="col-sm-8"><%= contractDetails.idSeries %> / <%= contractDetails.idNumber %></dd>
        <% if (contractDetails.cnp) { %>
        <dt class="col-sm-4">CNP</dt>
        <dd class="col-sm-8"><%= contractDetails.cnp %></dd>
        <% } %>
        <dt class="col-sm-4">Adresa domiciliu</dt>
        <dd class="col-sm-8"><%= contractDetails.address %></dd>
      </dl>
    </div>
    <% } %>
    <% } %>

    <% function formatTimelineName(name, role) {
      if (!role || role === 'client') {
        return name || 'Autor necunoscut';
      }
      const parts = (name || '').trim().split(/\s+/);
      const firstName = parts[0] || 'Echipa';
      return `${firstName}, Echipa Licente la Cheie`;
    } %>
    <div class="glass-card mt-4">
      <form action="/cont/tichete/<%= ticket.id %>/raspuns" method="post" class="vstack gap-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div>
          <label class="form-label" for="message">Adauga raspuns</label>
          <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
        </div>
        <button class="btn btn-gradient align-self-end" type="submit">Trimite raspuns</button>
      </form>
    </div>

    <div
      class="timeline mt-4"
      data-timeline
      data-ticket-id="<%= ticket.id %>"
      data-offset="<%= timelineEntries.length %>"
      data-limit="<%= timelinePageSize %>"
    >
      <% timelineEntries.forEach((entry) => { %>
      <div class="timeline-item" data-entry-type="<%= entry.entry_type %>" data-entry-id="<%= entry.entry_id %>">
        <div class="timeline-content">
          <h2 class="h6"><%= entry.entry_type === 'ticket' ? 'Mesaj initial' : 'Raspuns' %></h2>
          <p><%= entry.message %></p>
          <small class="text-muted"><%= entry.entry_type === 'ticket' ? 'Creat de' : 'Trimis de' %> <%= formatTimelineName(entry.author_name, entry.author_role) %></small>
        </div>
      </div>
      <% }) %>
    </div>
    <% if (hasMoreTimeline) { %>
    <div class="text-center mt-3">
      <button class="btn btn-outline-primary" type="button" data-timeline-load>Vezi mai mult</button>
    </div>
    <% } %>

    <% if (['admin', 'superadmin'].includes(currentUser.role)) { %>
    <div class="glass-card mt-4">
      <form action="/cont/tichete/<%= ticket.id %>/status" method="post" class="d-flex flex-column flex-sm-row gap-3 align-items-sm-end">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <div class="flex-grow-1 w-100">
          <label class="form-label" for="status">Actualizeaza statusul</label>
          <select class="form-select" id="status" name="status">
            <option value="deschis">Deschis</option>
            <option value="in-analiza">In analiza</option>
            <option value="rezolvat">Rezolvat</option>
          </select>
        </div>
        <button class="btn btn-outline-primary" type="submit">Salveaza</button>
      </form>
    </div>
    <% } %>
  </div>
</section>
<script>
  (function () {
    const forms = document.querySelectorAll('[data-signature-form]');
    forms.forEach((form) => {
      const canvas = form.querySelector('canvas');
      const pad = form.querySelector('[data-signature-pad]');
      const ctx = canvas.getContext('2d');
      const hiddenInput = form.querySelector('input[name="signatureData"]');
      const clearButton = form.querySelector('[data-signature-clear]');
      const errorMessage = form.querySelector('[data-signature-error]');
      let drawing = false;
      let hasSignature = false;

      function resizeCanvas() {
        const ratio = window.devicePixelRatio || 1;
        const width = pad.clientWidth;
        const height = 180;
        canvas.width = width * ratio;
        canvas.height = height * ratio;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(ratio, ratio);
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        if (!hasSignature) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      function getPosition(event) {
        const rect = canvas.getBoundingClientRect();
        return {
          x: ((event.clientX - rect.left) / rect.width) * canvas.width,
          y: ((event.clientY - rect.top) / rect.height) * canvas.height
        };
      }

      function startDrawing(event) {
        if (event.pointerType === 'mouse' && event.buttons !== 1) {
          return;
        }
        if (errorMessage) {
          errorMessage.classList.add('d-none');
        }
        drawing = true;
        hasSignature = true;
        ctx.beginPath();
        const pos = getPosition(event);
        ctx.moveTo(pos.x, pos.y);
        if (canvas.setPointerCapture) {
          canvas.setPointerCapture(event.pointerId);
        }
      }

      function draw(event) {
        if (!drawing) {
          return;
        }
        const pos = getPosition(event);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      }

      function endDrawing(event) {
        if (!drawing) {
          return;
        }
        draw(event);
        drawing = false;
        if (canvas.releasePointerCapture) {
          try {
            canvas.releasePointerCapture(event.pointerId);
          } catch (err) {
            /* ignore release errors */
          }
        }
      }

      function clearCanvas() {
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        resizeCanvas();
        hasSignature = false;
        if (hiddenInput) {
          hiddenInput.value = '';
        }
        if (errorMessage) {
          errorMessage.classList.add('d-none');
        }
      }

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      canvas.addEventListener('pointerdown', startDrawing);
      canvas.addEventListener('pointermove', draw);
      canvas.addEventListener('pointerup', endDrawing);
      canvas.addEventListener('pointercancel', endDrawing);

      if (clearButton) {
        clearButton.addEventListener('click', (event) => {
          event.preventDefault();
          clearCanvas();
        });
      }

      form.addEventListener('submit', (event) => {
        if (!hasSignature) {
          event.preventDefault();
          if (errorMessage) {
            errorMessage.classList.remove('d-none');
          }
          return;
        }
        if (hiddenInput) {
          hiddenInput.value = canvas.toDataURL('image/png');
        }
      });
    });

    const timeline = document.querySelector('[data-timeline]');
    if (timeline) {
      const loadMoreButton = document.querySelector('[data-timeline-load]');
      const ticketId = timeline.getAttribute('data-ticket-id');
      const limit = Number(timeline.getAttribute('data-limit') || '10');
      let offset = Number(timeline.getAttribute('data-offset') || '0');

      function formatTimelineNameClient(name, role) {
        if (!role || role === 'client') {
          return name || 'Autor necunoscut';
        }
        const parts = (name || '').trim().split(/\s+/);
        const firstName = parts[0] || 'Echipa';
        return `${firstName}, Echipa Licente la Cheie`;
      }

      function createMessageParagraph(message) {
        const paragraph = document.createElement('p');
        const lines = `${message ?? ''}`.split(/\n/);
        lines.forEach((line, index) => {
          if (index > 0) {
            paragraph.appendChild(document.createElement('br'));
          }
          paragraph.appendChild(document.createTextNode(line));
        });
        return paragraph;
      }

      function renderTimelineEntry(entry) {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        item.setAttribute('data-entry-type', entry.entry_type);
        item.setAttribute('data-entry-id', entry.entry_id);

        const content = document.createElement('div');
        content.className = 'timeline-content';
        item.appendChild(content);

        const title = document.createElement('h2');
        title.className = 'h6';
        title.textContent = entry.entry_type === 'ticket' ? 'Mesaj initial' : 'Raspuns';
        content.appendChild(title);

        content.appendChild(createMessageParagraph(entry.message));

        const meta = document.createElement('small');
        meta.className = 'text-muted';
        const prefix = entry.entry_type === 'ticket' ? 'Creat de ' : 'Trimis de ';
        meta.textContent = `${prefix}${formatTimelineNameClient(entry.author_name, entry.author_role)}`;
        content.appendChild(meta);

        return item;
      }

      if (loadMoreButton) {
        loadMoreButton.addEventListener('click', async () => {
          loadMoreButton.disabled = true;
          const originalText = loadMoreButton.textContent;
          loadMoreButton.textContent = 'Se incarca...';
          try {
            const response = await fetch(
              `/cont/tichete/${ticketId}/timeline?offset=${offset}&limit=${limit}`,
              {
                headers: {
                  Accept: 'application/json'
                }
              }
            );

            if (!response.ok) {
              throw new Error('Network response was not ok');
            }

            const data = await response.json();
            if (Array.isArray(data.entries)) {
              data.entries.forEach((entry) => {
                timeline.appendChild(renderTimelineEntry(entry));
              });
            }

            if (typeof data.nextOffset === 'number') {
              offset = data.nextOffset;
            } else if (Array.isArray(data.entries)) {
              offset += data.entries.length;
            }
            timeline.setAttribute('data-offset', String(offset));

            if (!data.hasMore) {
              loadMoreButton.remove();
            } else {
              loadMoreButton.disabled = false;
              loadMoreButton.textContent = originalText;
            }
          } catch (error) {
            loadMoreButton.disabled = false;
            loadMoreButton.textContent = originalText;
            window.alert('Nu am putut incarca mesaje suplimentare. Incearca din nou.');
          }
        });
      }
    }
  })();
</script>
<%- include('../partials/footer') %>
