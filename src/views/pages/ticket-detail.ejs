<%- include('../partials/head', { title, description, request }) %>
<%- include('../partials/header') %>
<section class="py-5">
  <div class="container" style="max-width: 800px;">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h1 class="h4 mb-3"><%= ticket.subject %></h1>
        <p class="text-muted">Status: <span class="badge bg-info text-dark"><%= ticket.status %></span></p>
        <% if (ticket.project_title) { %>
        <p class="mb-0">Proiect: <strong><%= ticket.project_title %></strong></p>
        <% } %>
      </div>
    </div>

    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-content">
          <h2 class="h6">Mesaj initial</h2>
          <p><%= ticket.message %></p>
          <small class="text-muted">Creat de <%= ticket.author_name %></small>
        </div>
      </div>
      <% replies.forEach((reply) => { %>
      <div class="timeline-item">
        <div class="timeline-content">
          <h2 class="h6">Raspuns</h2>
          <p><%= reply.message %></p>
          <small class="text-muted">Trimis de <%= reply.author_name %></small>
        </div>
      </div>
      <% }) %>
    </div>

    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <form action="/cont/tichete/<%= ticket.id %>/raspuns" method="post" class="vstack gap-3">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <div>
            <label class="form-label" for="message">Adauga raspuns</label>
            <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
          </div>
          <button class="btn btn-primary" type="submit">Trimite raspuns</button>
        </form>
      </div>
    </div>

    <% if (['admin', 'superadmin'].includes(currentUser.role)) { %>
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <form action="/cont/tichete/<%= ticket.id %>/status" method="post" class="d-flex gap-3 align-items-end">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <div class="flex-grow-1">
            <label class="form-label" for="status">Actualizeaza statusul</label>
            <select class="form-select" id="status" name="status">
              <option value="deschis">Deschis</option>
              <option value="in-analiza">In analiza</option>
              <option value="rezolvat">Rezolvat</option>
            </select>
          </div>
          <button class="btn btn-outline-primary" type="submit">Salveaza</button>
        </form>
      </div>
    </div>
    <% } %>
  </div>
</section>
<%- include('../partials/footer') %>
