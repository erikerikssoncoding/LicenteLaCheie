<%- include('../partials/head', { title, description, request }) %>
<%- include('../partials/header') %>
<section class="py-5">
  <div class="container">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3">Bun venit, <%= currentUser.fullName %></h1>
        <p class="text-muted mb-0">Rol: <span class="badge bg-secondary text-uppercase"><%= currentUser.role %></span></p>
      </div>
      <% if (['admin', 'superadmin'].includes(currentUser.role)) { %>
      <a class="btn btn-primary" href="/cont/proiecte/creeaza">Creaza proiect</a>
      <% } %>
    </div>

    <% if (currentUser.role === 'client') { %>
    <div class="row g-4 mb-4">
      <div class="col-lg-4 col-md-6">
        <%- include('../partials/dashboard/cards/summary-card', {
          title: 'Urmatorul deadline',
          badge: clientHighlights.nextDeadline ? clientHighlights.nextDeadline.deadline?.toISOString ? clientHighlights.nextDeadline.deadline.toISOString().slice(0,10) : clientHighlights.nextDeadline.deadline : null,
          items: clientHighlights.nextDeadline
            ? [{
                title: clientHighlights.nextDeadline.title,
                subtitle: clientHighlights.nextDeadline.admin_name
                  ? `Administrator: ${clientHighlights.nextDeadline.admin_name}`
                  : clientHighlights.nextDeadline.redactor_name
                  ? `Redactor: ${clientHighlights.nextDeadline.redactor_name}`
                  : 'Deadline confirmat'
              }]
            : [],
          emptyMessage: 'Nu exista un deadline stabilit.'
        }) %>
      </div>
      <div class="col-lg-4 col-md-6">
        <%- include('../partials/dashboard/cards/summary-card', {
          title: 'Echipa alocata',
          badge: `${clientHighlights.admins.length + clientHighlights.redactors.length} membri`,
          items: [
            ...clientHighlights.admins.map((member) => ({
              title: member.full_name,
              subtitle: 'Administrator dedicat'
            })),
            ...clientHighlights.redactors.map((member) => ({
              title: member.full_name,
              subtitle: 'Redactor asignat'
            }))
          ],
          emptyMessage: 'Inca nu a fost alocata o echipa.'
        }) %>
      </div>
      <% const offerStatusLabels = {
        pending: 'In pregatire',
        sent: 'Trimisa',
        accepted: 'Acceptata',
        refused: 'Refuzata',
        expired: 'Expirata',
        counter_pending: 'Contraoferta in asteptare',
        counter_submitted: 'Contraoferta trimisa'
      }; %>
      <div class="col-lg-4 col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0">Ofertele tale</h2>
              <a class="btn btn-sm btn-outline-primary" href="/cont/tichete/creeaza">Deschide ticket</a>
            </div>
            <% if (!offers || offers.length === 0) { %>
            <p class="text-muted mb-0">Nu exista oferte active.</p>
            <% } else { %>
            <ul class="list-group list-group-flush">
              <% offers.slice(0, 3).forEach((offer) => { %>
              <li class="list-group-item">
                <div class="fw-semibold">Oferta <%= offer.offer_code %></div>
                <div class="small text-muted">Status: <%= offerStatusLabels[offer.status] || offer.status %></div>
                <a class="btn btn-sm btn-link px-0" href="/cont/tichete/<%= offer.ticket_id %>">Deschide ticket</a>
              </li>
              <% }) %>
            </ul>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <% if (currentUser.role === 'redactor') { %>
    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <%- include('../partials/dashboard/cards/status-card', {
          title: 'Starea proiectelor',
          statuses: redactorHighlights.statusCounts.map((item) => ({
            label: item.status,
            total: item.total
          })),
          emptyMessage: 'Nu ai proiecte asignate momentan.'
        }) %>
      </div>
      <div class="col-lg-6">
        <%- include('../partials/dashboard/cards/summary-card', {
          title: 'Livrari apropiate',
          badge: redactorHighlights.upcomingDeadlines.length ? `${redactorHighlights.upcomingDeadlines.length} proiecte` : null,
          items: redactorHighlights.upcomingDeadlines.map((project) => ({
            title: project.title,
            subtitle: project.deadline?.toISOString ? project.deadline.toISOString().slice(0,10) : project.deadline
          })),
          emptyMessage: 'Nu sunt livrari in perioada urmatoare.'
        }) %>
      </div>
    </div>
    <% } %>

    <% if (['admin', 'superadmin'].includes(currentUser.role)) { %>
    <div class="row g-4 mb-4">
      <div class="col-xl-6">
        <%- include('../partials/dashboard/cards/status-card', {
          title: 'Proiecte pe status',
          statuses: adminHighlights.statusCounts.map((item) => ({
            label: item.status,
            total: item.total
          })),
          emptyMessage: 'Nu exista proiecte in portofoliul tau.'
        }) %>
      </div>
      <div class="col-xl-6">
        <%- include('../partials/dashboard/cards/summary-card', {
          title: 'Ultimele proiecte asignate',
          badge: adminHighlights.recentProjects.length ? `${adminHighlights.recentProjects.length} proiecte` : null,
          items: adminHighlights.recentProjects.map((project) => ({
            title: project.title,
            subtitle: `${project.client_name || 'Client nealocat'} • ${project.deadline ? (project.deadline.toISOString ? project.deadline.toISOString().slice(0,10) : project.deadline) : 'Fara deadline'}`
          })),
          emptyMessage: 'Nu ai proiecte alocate recent.'
        }) %>
      </div>
    </div>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Meniu administrare</h2>
        <p class="text-muted">Acceseaza rapid instrumentele dedicate supervizarii echipei si a clientilor.</p>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-outline-primary" href="/cont/utilizatori">Administrare utilizatori</a>
          <a class="btn btn-outline-primary" href="/cont/tichete">Administrare tichete</a>
          <a class="btn btn-outline-primary" href="/cont/proiecte/creeaza">Creaza proiect</a>
          <a class="btn btn-outline-primary" href="/cont">Vizualizeaza proiectele active</a>
        </div>
      </div>
    </div>
    <% } %>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0">Proiectele tale</h2>
              <% if (currentUser.role === 'client') { %>
              <a class="btn btn-sm btn-outline-primary" href="/cont/tichete/creeaza">Deschide ticket</a>
              <% } %>
            </div>
            <% if (projects.length === 0) { %>
            <p class="text-muted">Momentan nu exista proiecte active.</p>
            <% } else { %>
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Titlu</th>
                    <th>Status</th>
                    <th>Responsabil</th>
                    <th>Deadline</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% projects.forEach((project) => { %>
                  <tr>
                    <td>
                      <div class="fw-semibold"><%= project.title %></div>
                      <div class="small text-muted"><%= project.degree_level %></div>
                    </td>
                    <td><span class="badge bg-info text-dark text-uppercase"><%= project.status %></span></td>
                    <td class="small">
                      <% if (currentUser.role === 'client') { %>
                      <div>Admin: <%= project.assigned_admin_name || 'In alocare' %></div>
                      <div>Redactor: <%= project.assigned_redactor_name || 'In alocare' %></div>
                      <% } else if (currentUser.role === 'redactor') { %>
                      <div>Client: <%= project.client_name %></div>
                      <% } else { %>
                      <div>Client: <%= project.client_name %></div>
                      <div>Redactor: <%= project.assigned_redactor_name || 'Nealocat' %></div>
                      <% } %>
                    </td>
                    <td><%= project.deadline ? project.deadline.toISOString ? project.deadline.toISOString().slice(0,10) : project.deadline : 'N/A' %></td>
                    <td class="text-end"><a class="btn btn-sm btn-outline-secondary" href="/cont/proiecte/<%= project.id %>">Detalii</a></td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <% } %>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h2 class="h5">Tichete recente</h2>
            <% if (tickets.length === 0) { %>
            <p class="text-muted">Nu exista tichete deschise.</p>
            <% } else { %>
            <ul class="list-group list-group-flush">
              <% tickets.slice(0, 5).forEach((ticket) => { %>
              <li class="list-group-item">
                <div class="fw-semibold"><%= ticket.subject %></div>
                <div class="small text-muted">Tip: <%= ticket.kind %> • Status: <%= ticket.status %></div>
                <a class="btn btn-sm btn-link px-0" href="/cont/tichete/<%= ticket.id %>">Vezi ticket</a>
              </li>
              <% }) %>
            </ul>
            <% } %>
            <% if (recentReplies && recentReplies.length > 0) { %>
            <div class="mt-4">
              <h3 class="h6">Raspunsuri noi</h3>
              <ul class="list-unstyled mb-0">
                <% recentReplies.forEach((reply) => { %>
                <li class="mb-2 small">
                  <strong><%= reply.subject %></strong> – actualizat recent
                </li>
                <% }) %>
              </ul>
            </div>
            <% } %>
          </div>
        </div>

        <% if (pendingSupportTickets && pendingSupportTickets.length > 0) { %>
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h2 class="h6 mb-3">Tichete ce necesita atentie</h2>
            <ul class="list-group list-group-flush">
              <% pendingSupportTickets.forEach((ticket) => { %>
              <li class="list-group-item">
                <div class="fw-semibold"><%= ticket.subject %></div>
                <div class="small text-muted">Status: <%= ticket.status %></div>
                <a class="btn btn-sm btn-link px-0" href="/cont/tichete/<%= ticket.id %>">Gestioneaza</a>
              </li>
              <% }) %>
            </ul>
          </div>
        </div>
        <% } %>

        <% if (pendingOffers && pendingOffers.length > 0) { %>
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h2 class="h6 mb-3">Oferte in asteptare</h2>
            <ul class="list-group list-group-flush">
              <% pendingOffers.forEach((offer) => { %>
              <li class="list-group-item">
                <div class="fw-semibold"><%= offer.client_name_full || offer.client_name %></div>
                <div class="small text-muted">Solicitare <%= offer.offer_code %> – status <%= offer.status %></div>
                <a class="btn btn-sm btn-link px-0" href="/cont/tichete/<%= offer.ticket_id %>">Deschide ticket</a>
              </li>
              <% }) %>
            </ul>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</section>
<%- include('../partials/footer') %>
